{% extends "mapApp/base.html" %}
{% load staticfiles %}
{% load geojson_tags %}


{% block title %}
	Monthly statistics
{% endblock %}


{% block headerCSS %}
	<!-- Load leaflet -->
	<link rel="stylesheet" href="{% static 'leaflet/leaflet.css' %}"/>

	<!-- Barchart style -->
	<link rel="stylesheet" href="{% static 'mapApp/css/barchart.css' %}"/>

	<!-- Local styles -->
	<link rel="stylesheet" href="{% static 'mapApp/css/stats.css' %}"/>
{% endblock %}

{% block headerJS %}
    <!-- d3 v3.4.8 -->
    <script src="{% static 'd3/d3.min.js' %}" charset="utf-8"></script>
    <!-- moment.js date library -->
    <script src="{% static 'moment/moment.min.js' %}"></script>
    <!-- Load leaflet -->
    <script src="{% static 'leaflet/leaflet.js' %}"></script>
		<!-- Icon definitions -->
    <script src="{% static 'mapApp/js/icons.js' %}" charset="utf-8"></script>
    <!-- Load marker clustering -->
    <script src="{% static 'leaflet/plugins/leaflet.markercluster/leaflet.markercluster-src.js' %}"></script>
    <!-- Load Maki Markers Icons -->
    <script src="{% static 'leaflet/plugins/maki-markers/Leaflet.MakiMarkers.js' %}"></script>
    <!-- Load heatmap -->
    <script src="{% static 'leaflet/plugins/leaflet-heat/leaflet-heat.js' %}"></script>
    <!-- map generating code -->
    <script src="{% static 'mapApp/js/map.js' %}" charset="utf-8"></script>
    <!-- d3 barchart -->
    <script src="{% static 'mapApp/js/stats.js' %}" charset="utf-8"></script>
{% endblock %}


{% block body %}
	<div id="fb-root"></div>
	<script>(function(d, s, id) {
	  var js, fjs = d.getElementsByTagName(s)[0];
	  if (d.getElementById(id)) return;
	  js = d.createElement(s); js.id = id;
	  js.src = "//connect.facebook.net/en_US/sdk.js#xfbml=1&version=v2.0";
	  fjs.parentNode.insertBefore(js, fjs);
	}(document, 'script', 'facebook-jssdk'));</script>

	<div class="container-fluid" style="height: 100%;">
		<div class="row" style="height: 100%;">

			<div class="col-xs-12 col-sm-6 map-col">
				<!-- Map of one month of reports -->
				<div id="map"></div>
			</div>

			<div id="graph-panel" class="col-xs-12 col-sm-6" style="margin-top: 15px;">
				<!-- Bar graph of Alert area points by type -->
				<!-- See http://bost.ocks.org/mike/bar/ for bar chart tutorials -->
				<div class="col-xs-12">
					<div class="panel panel-primary">
					  <div class="panel-heading" id="barchart-title">Reports this month</div>
					  <div class="panel-body" id="barchart-body">
						<svg id="barchart"
							viewBox="0 0 500 250"
						  preserveAspectRatio="none">
						</svg>
					  </div>
					</div>
				</div>

				<!-- Shameless self promotion material -->
				<div class="col-xs-12">
					<div id="carousel-example-generic" class="carousel slide" data-ride="carousel">
					  <!-- Indicators -->
					  <ol class="carousel-indicators">
					    <li data-target="#carousel-example-generic" data-slide-to="0" class="active"></li>
					    <li data-target="#carousel-example-generic" data-slide-to="1"></li>
					    <li data-target="#carousel-example-generic" data-slide-to="2"></li>
					    <li data-target="#carousel-example-generic" data-slide-to="3"></li>
					  </ol>

					  <!-- Wrapper for slides -->
					  <div class="carousel-inner" role="listbox">
					    <div class="item active">
					      <img class="img-responsive center-block" src="{% static 'mapApp/images/updates/countries.jpg' %}" alt="Countries mapping" style="max-height:80%;">
					    </div>
					    <div class="item">
					      <img class="img-responsive center-block" src="{% static 'mapApp/images/updates/Piechartnov14.jpg' %}" alt="What is being mapped" style="max-height:80%;">
					    </div>
					    <div class="item">
					      <img class="img-responsive center-block" src="{% static 'mapApp/images/updates/fatalityrates.jpg' %}" alt="Fatality rates" style="max-height:80%;">
					    </div>
					    <div class="item">
								<h4>Check out BikeMaps on Facebook and Twitter!</h4>
								<!-- Facebook like button -->
								<div class="col-xs-6 text-center">
									<!-- Facebook -->
									<div style="background: white;" class="fb-like-box" data-href="https://www.facebook.com/pages/BikeMapsorg/337283939811392" data-colorscheme="light" data-show-faces="false" data-header="true" data-stream="true" data-show-border="true"></div>
								</div>

								<!-- Twitter follow button -->
								<div class="col-xs-5 text-center">
									<a class="twitter-timeline" href="https://twitter.com/BikeMapsTeam" data-widget-id="542782010914127872">Tweets by @BikeMapsTeam</a>
									<script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+"://platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>
								</div>
					    </div>
					  </div>

					  <!-- Controls -->
					  <a class="left carousel-control" href="#carousel-example-generic" role="button" data-slide="prev">
					    <span class="glyphicon glyphicon-chevron-left"></span>
					    <span class="sr-only">Previous</span>
					  </a>
					  <a class="right carousel-control" href="#carousel-example-generic" role="button" data-slide="next">
					    <span class="glyphicon glyphicon-chevron-right"></span>
					    <span class="sr-only">Next</span>
					  </a>
					</div>
				</div>

			</div>
		</div>
	</div>

	<script>
		// Make barchart resize responsive
		var barchart = $("#barchart"),
			container = barchart.parent();
		$(window).ready(function() {
			var targetHeight = ($("#graph-panel").height() - 200);
			var targetWidth = container.width();
				barchart.attr("width", targetWidth);
				barchart.attr("height", targetHeight/2);
		}).trigger("resize");
		$(window).on("resize", function() {
			targetHeight = ($("#graph-panel").height() - 200);
			targetWidth = container.width();
			barchart.attr("width", targetWidth);
			barchart.attr("height", targetHeight/2);
		}).trigger("resize");


		// Create the map (call to map.js)
    initialize(scrollZoom=false {% if request.mobile %}, mobile=true {% endif %});

    var areasLatLngList = [];
    {% for polygon in geofences %}
    	areasLatLngList.push({{ polygon.latlngList }});
      // Add polygon to map
      getPolygon( {{ polygon.latlngList }}, {{ polygon.pk }} );
    {% endfor %}
   	// Fit map extent to alert areas boundary
		if (areasLatLngList.length > 0) {
	    map.fitBounds(L.latLngBounds(areasLatLngList));
		}

    var data = {
			// Points in a user polygon
			collisionsROI: {{ collisionsInPoly|geojsonfeature:"date"|safe }},
			nearmissesROI: {{ nearmissesInPoly|geojsonfeature:"date"|safe }},
			hazardsROI: 	{{ hazardsInPoly|geojsonfeature:"date"|safe }},
			theftsROI: 	{{ theftsInPoly|geojsonfeature:"date"|safe }},

			// All points
			collisions: {{ collisions|geojsonfeature:"date"|safe }},
			nearmisses: {{ nearmisses|geojsonfeature:"date"|safe }},
			hazards: 	{{ hazards|geojsonfeature:"date"|safe }},
			thefts: 	{{ thefts|geojsonfeature:"date"|safe }},

			// Make dates to use for filtering
			now: moment(),
			oneMonthAgo: moment().subtract(1, 'month'),
			twoMonthsAgo: moment().subtract(2, 'months'),
			threeMonthsAgo: moment().subtract(3, 'months')
		};

		// Add date information to barchart title
		$('#barchart-title').append(" ( " + data.oneMonthAgo.format("MMM D, YYYY") + " - " + data.now.format("MMM D, YYYY") + " )")

		// Filter by date to get different datasets
		// TODO do this in stats.js
		var collisionsThisMonth = filterGeoJSONByDate(data.collisionsROI, data.oneMonthAgo, data.now),
			nearmissesThisMonth = filterGeoJSONByDate(data.nearmissesROI, data.oneMonthAgo, data.now),
			hazardsThisMonth = filterGeoJSONByDate(data.hazardsROI, data.oneMonthAgo, data.now),
			theftsThisMonth = filterGeoJSONByDate(data.theftsROI, data.oneMonthAgo, data.now);

    // Add points to map, create layers used by stats.js to highlight points on map
		// All points in the polygon that occured in the previous month
		var recentCollisionsLayer = geojsonCircleMarker(collisionsThisMonth, "collision").addTo(map),
			recentNearmissesLayer = geojsonCircleMarker(nearmissesThisMonth, "nearmiss").addTo(map),
			recentHazardsLayer = geojsonCircleMarker(hazardsThisMonth, "hazard").addTo(map),
			recentTheftsLayer = geojsonCircleMarker(theftsThisMonth, "theft").addTo(map),

			allCollisionsLayer = geojsonCircleMarker(data.collisions, "collision").addTo(map),
			allNearmissesLayer = geojsonCircleMarker(data.nearmisses, "nearmiss").addTo(map),
			allHazardsLayer = geojsonCircleMarker(data.hazards, "hazard").addTo(map),
			allTheftsLayer = geojsonCircleMarker(data.thefts, "theft").addTo(map);

		// Create dataset out of django context
		// Note, data and counts are for last month of points in user alert areas only, not total points
		{% if geofences|length > 0 %}
			initializeBarChart([
				{ type: "collision", 	value: collisionsThisMonth.features.length, 	color: getColor("collision") },
				{ type: "nearmiss", 	value: nearmissesThisMonth.features.length, 	color: getColor("nearmiss") },
				{ type: "hazard", 		value: hazardsThisMonth.features.length, 		color: getColor("hazard") },
				{ type: "theft", 		value: theftsThisMonth.features.length, 		color: getColor("theft") }
			]);
		{% else %}
			$('#barchart-body').append("<p>Trace out an alert area on the main map page to see data visualizations for that area.</p>");
		{% endif %}

	</script>

{% endblock %}
