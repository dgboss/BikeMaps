{% extends "mapApp/base.html" %}

<!-- HEAD STUFF -->
{% load staticfiles crispy_forms_tags %}
{% block headerCSS %}
    <!-- Load leaflet -->
    <link rel="stylesheet" href="{% static 'leaflet/leaflet.css' %}"/>

    <!-- Load marker clustering -->
    <link rel="stylesheet" href="{% static 'leaflet/plugins/leaflet.markercluster/MarkerCluster.css' %}">
    <link rel="stylesheet" href="{% static 'leaflet/plugins/leaflet.markercluster/MarkerCluster.Default.css' %}">

    <!-- Load draw pluging -->
    <link rel="stylesheet" href="{% static 'leaflet/plugins/leaflet.draw/dist/leaflet.draw.css' %}">

    <!-- Leaflet Geocoder -->
    <link rel="stylesheet" href="{% static 'leaflet/plugins/leaflet-control-geocoder/Control.Geocoder.css' %}">

    <!-- WebGL heatmap -->
    <link rel="stylesheet" href="{% static 'leaflet/plugins/webgl-heatmap/css/shCoreEclipse.css' %}">
    
{% endblock %}

{% block headerJS %}
    <!-- LOAD JS -->
    <!-- Load leaflet -->
    <script src="{% static 'leaflet/leaflet.js' %}"></script>

    <!-- Load marker clustering -->
    <script src="{% static 'leaflet/plugins/leaflet.markercluster/leaflet.markercluster-src.js' %}"></script>

    <!-- Load Maki Markers Icons -->
    <script src="{% static 'leaflet/plugins/maki-markers/Leaflet.MakiMarkers.js' %}"></script>

    <!-- Load heatmap -->
    <!-- <script src="{% static 'leaflet/plugins/leaflet-heat/leaflet-heat.js' %}"></script> -->
    <script src="{% static 'leaflet/plugins/webgl-heatmap/js/shCore.js' %}"></script>
    <script src="{% static 'leaflet/plugins/webgl-heatmap/js/shBrushJScript.js' %}"></script>
    <script src="{% static 'leaflet/plugins/webgl-heatmap/js/webgl-heatmap.js' %}"></script>
    <script src="{% static 'leaflet/plugins/webgl-heatmap/js/webgl-heatmap-leaflet.js' %}"></script>

    <!-- Load draw pluging -->
    <script src="{% static 'leaflet/plugins/leaflet.draw/src/Leaflet.draw.js' %}"></script>
    
    <script src="{% static 'leaflet/plugins/leaflet.draw/src/edit/handler/Edit.Poly.js' %}"></script>
    <script src="{% static 'leaflet/plugins/leaflet.draw/src/edit/handler/Edit.SimpleShape.js' %}"></script>
    <script src="{% static 'leaflet/plugins/leaflet.draw/src/edit/handler/Edit.Circle.js' %}"></script>
    <script src="{% static 'leaflet/plugins/leaflet.draw/src/edit/handler/Edit.Rectangle.js' %}"></script>
    
    <script src="{% static 'leaflet/plugins/leaflet.draw/src/draw/handler/Draw.Feature.js' %}"></script>
    <script src="{% static 'leaflet/plugins/leaflet.draw/src/draw/handler/Draw.Polyline.js' %}"></script>
    <script src="{% static 'leaflet/plugins/leaflet.draw/src/draw/handler/Draw.Polygon.js' %}"></script>
    <script src="{% static 'leaflet/plugins/leaflet.draw/src/draw/handler/Draw.SimpleShape.js' %}"></script>
    <script src="{% static 'leaflet/plugins/leaflet.draw/src/draw/handler/Draw.Rectangle.js' %}"></script>
    <script src="{% static 'leaflet/plugins/leaflet.draw/src/draw/handler/Draw.Circle.js' %}"></script>
    <script src="{% static 'leaflet/plugins/leaflet.draw/src/draw/handler/Draw.Marker.js' %}"></script>

    <script src="{% static 'leaflet/plugins/leaflet.draw/src/ext/LatLngUtil.js' %}"></script>
    <script src="{% static 'leaflet/plugins/leaflet.draw/src/ext/GeometryUtil.js' %}"></script>
    <script src="{% static 'leaflet/plugins/leaflet.draw/src/ext/LineUtil.Intersect.js' %}"></script>
    <script src="{% static 'leaflet/plugins/leaflet.draw/src/ext/Polyline.Intersect.js' %}"></script>
    <script src="{% static 'leaflet/plugins/leaflet.draw/src/ext/Polygon.Intersect.js' %}"></script>

    <script src="{% static 'leaflet/plugins/leaflet.draw/src/Control.Draw.js' %}"></script>
    <script src="{% static 'leaflet/plugins/leaflet.draw/src/Tooltip.js' %}"></script>
    <script src="{% static 'leaflet/plugins/leaflet.draw/src/Toolbar.js' %}"></script>

    <script src="{% static 'leaflet/plugins/leaflet.draw/src/draw/DrawToolbar.js' %}"></script>
    <script src="{% static 'leaflet/plugins/leaflet.draw/src/edit/EditToolbar.js' %}"></script>
    <script src="{% static 'leaflet/plugins/leaflet.draw/src/edit/handler/EditToolbar.Edit.js' %}"></script>
    <script src="{% static 'leaflet/plugins/leaflet.draw/src/edit/handler/EditToolbar.Delete.js' %}"></script> 

    <!-- Load leaflet easy button -->
    <script src="{% static 'leaflet/plugins/easy-button/easy-button.js' %}"></script> 

    <!-- Used for pie chart creation -->
    <!-- d3 v3.4.8 -->
    <script src="{% static 'd3/d3.min.js' %}" charset="utf-8"></script> 

    <!-- Leaflet Geocoder -->
    <script src="{% static 'leaflet/plugins/leaflet-control-geocoder/Control.Geocoder.js' %}"></script> 

    <!-- Tooltips script -->
    <script src="{% static 'mapApp/js/tooltips.js' %}"></script>
    
    <!-- GeoJSON sources -->
    <script src="{% static 'mapApp/data/policeData.js' %}"></script> 
    <script src="{% static 'mapApp/data/icbcData.js' %}"></script>

    <!-- Load app js -->
    <script src="{% static 'mapApp/js/map.js' %}"></script>
{% endblock %}

{% block title %}BikeMaps{% endblock %}

<!-- BODY STUFF -->
{% block body %}
    {% crispy geofenceForm %}
    {% include 'mapApp/incident_form.html' %}
    
    <!-- Leaflet map --> 
    <div id="map"></div>

    <!-- JS to control message display and feature creation -->
    <script>
        // Show modals if there are from errors
        {% if incidentForm.errors %}
        $(window).load(function(){
            $('#incidentForm').modal('show');
        });
        {% endif %}

        {% if hazardForm.errors %}
        $(window).load(function(){
            $('.nav-tabs a[href="#hazardReport"]').tab('show')
            $('#incidentForm').modal('show');
        });
        {% endif %}

        {% if theftForm.errors %}
        $(window).load(function(){
            $('.nav-tabs a[href="#theftReport"]').tab('show')
            $('#incidentForm').modal('show');
        });
        {% endif %}

        {% if geofenceForm.errors %}
        $(window).load(function(){
            $('#geofenceForm').modal('show');
        });
        {% endif %}
        
        
        // Load user points from the database
        {% for incident in incidents %}
            getPoint( {{ incident.latlngList }}, "{{incident.incident_type}}", {{ incident.pk }}, 
                '<strong>Type:</strong> {{ incident.incident }}<br>'
                + '<strong>{% if incident.incident_type != "Fall" %}Incident with'
                + '{% else %}Due to{% endif %}:</strong> {{ incident.incident_with }}<br>'
                + '<strong>Date:</strong> {{ incident.incident_date }}'
            );
        {% endfor %}

        // Load user hazards from the database
        {% for hazard in hazards %}
            getPoint( {{ hazard.latlngList }}, "Hazard", {{ hazard.pk }},
                '<strong>Hazard type:</strong> {{ hazard.hazard }}<br>'
                + '<strong>Date:</strong> {{ hazard.hazard_date }}'
            );
        {% endfor %}

        {% for theft in thefts %}
            getPoint( {{ theft.latlngList }}, "Theft", {{ theft.pk }},
                '<strong>Theft type:</strong> {{ theft.theft }}<br>'
                + '<strong>Date:</strong> {{ theft.theft_date }}'
                );
        {% endfor %}

        // Load user alert areas from the database
        {% for polygon in geofences %}
            getPolygon( {{ polygon.latlngList }}, {{ polygon.pk }} ); 
        {% endfor %}


        // Create the map (call to map.js)
        initialize({% if request.mobile %} mobile=true {% endif %});

        setView({% if zoom %} {{ lat }}, {{ lng }}, {{ zoom}} {% endif %});
    </script>

    <!-- Add Leaflet.draw controls and actions -->
    {% include 'mapApp/util/draw.html' %}

    <!-- TODO add mobile controls to record paths or take pictures etc. -->

    <div class="modal fade" id="about-alert-areas">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            <h4 class="modal-title text-center">Receive monthly alerts for your riding area.</h4>
          </div>
          <div class="modal-body">
            To setup monitoring areas:
                <ol>
                    <li>Login to your account
                    <li>Trace areas on the map you would like to track using the <span id="polygon-sprite"></span> button.
                        <br><small><em>note: tracing is currently not supported on mobile devices.</em></small>
                </ol>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
            <div class="btn-group">
                <a href="{% url 'spirit:user-register' %}" type="button" class="btn btn-primary">Register</a>
                <a href="{% url 'spirit:user-login' %}" type="button" class="btn btn-primary">Login</a>
            </div>
          </div>
        </div><!-- /.modal-content -->
      </div><!-- /.modal-dialog -->
    </div><!-- /.modal -->
{% endblock %}